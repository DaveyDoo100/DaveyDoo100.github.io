<script>
  const secretBox = document.getElementById("secret-box");
  const gameContainer = document.getElementById("game-container");
  const closeGameBtn = document.getElementById("close-game");
  const canvas = document.getElementById("gameCanvas");
  const ctx = canvas.getContext("2d");

  let gameInterval, gravity, cat, pipes, score, gameOver;
  const catImg = new Image();
  catImg.src = "https://i.ibb.co/khgFL2j/cat.png"; // Cat sprite

  const pipeMarble = new Image();
  pipeMarble.src = "https://i.ibb.co/9vmTbYP/black-gold-marble.jpg"; // Marble texture

  function resetGame() {
    gravity = 0.4;
    score = 0;
    gameOver = false;
    cat = { x: 50, y: 300, width: 40, height: 40, velocity: 0 };
    pipes = [];
  }

  function startGame() {
    resetGame();
    gameInterval = setInterval(updateGame, 20);
  }

  function endGame() {
    clearInterval(gameInterval);
    ctx.fillStyle = "rgba(0,0,0,0.7)";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "#d4af37";
    ctx.font = "36px Poppins";
    ctx.fillText("Game Over", canvas.width / 2 - 90, canvas.height / 2);
    ctx.font = "20px Poppins";
    ctx.fillText("Score: " + score, canvas.width / 2 - 40, canvas.height / 2 + 40);
    gameOver = true;
  }

  function drawCat() {
    ctx.drawImage(catImg, cat.x, cat.y, cat.width, cat.height);
  }

  function drawPipes() {
    for (let pipe of pipes) {
      // Top pipe
      ctx.drawImage(pipeMarble, pipe.x, 0, pipe.width, pipe.top);
      // Bottom pipe
      ctx.drawImage(pipeMarble, pipe.x, canvas.height - pipe.bottom, pipe.width, pipe.bottom);
    }
  }

  function updateGame() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Gravity
    cat.velocity += gravity;
    cat.y += cat.velocity;

    // Collision with floor/ceiling
    if (cat.y + cat.height > canvas.height || cat.y < 0) {
      endGame();
    }

    // Generate pipes
    if (pipes.length === 0 || pipes[pipes.length - 1].x < 250) {
      let topHeight = Math.random() * (canvas.height - 200) + 50;
      let gap = 140;
      pipes.push({
        x: canvas.width,
        width: 60,
        top: topHeight,
        bottom: canvas.height - topHeight - gap
      });
    }

    for (let i = 0; i < pipes.length; i++) {
      let pipe = pipes[i];
      pipe.x -= 3;

      // Collision detection
      if (
        cat.x < pipe.x + pipe.width &&
        cat.x + cat.width > pipe.x &&
        (cat.y < pipe.top || cat.y + cat.height > canvas.height - pipe.bottom)
      ) {
        endGame();
      }

      // Score
      if (!pipe.passed && pipe.x + pipe.width < cat.x) {
        score++;
        pipe.passed = true;
      }
    }

    // Remove off-screen pipes
    pipes = pipes.filter(pipe => pipe.x + pipe.width > 0);

    // Draw
    drawCat();
    drawPipes();

    ctx.fillStyle = "#fff";
    ctx.font = "20px Poppins";
    ctx.fillText("Score: " + score, 10, 30);
  }

  // Controls
  function jump() {
    if (!gameOver) {
      cat.velocity = -7;
    }
  }
  document.addEventListener("keydown", (e) => {
    if (e.code === "Space") jump();
  });
  canvas.addEventListener("click", jump);

  // Show/Hide game
  secretBox.addEventListener("click", () => {
    gameContainer.style.display = "flex";
    startGame();
  });

  closeGameBtn.addEventListener("click", () => {
    gameContainer.style.display = "none";
    clearInterval(gameInterval);
  });
</script>
